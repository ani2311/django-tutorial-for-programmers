
    <html>
      <head>
        <title>Chapter15</title>
       <meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" type="text/css" href="style.css">
      </head>
      <body>
<div class="nav">
        <ul>
          <li><a href="01-before-we-start.md.html">ch01 before we start</a></li>
          <li><a href="02-how-does-django-work.md.html">ch02 how does django work</a></li>
          <li><a href="03-a-new-project.md.html">ch03 a new project</a></li>
          <li><a href="04-run-your-project.md.html">ch04 run your project</a></li>
          <li><a href="05-django-apps.md.html">ch05 django apps</a></li>
          <li><a href="06-first-view.md.html">ch06 first view</a></li>
          <li><a href="07-django-models.md.html">ch07 django models</a></li>
          <li><a href="08-django-admin.md.html">ch08 django admin</a></li>
          <li><a href="09-model-view.md.html">ch09 model view</a></li>
          <li><a href="10-testing.md.html">ch10 testing</a></li>
          <li><a href="11-view-refactoring.md.html">ch11 view refactoring</a></li>
          <li><a href="12-view-refactoring-2.md.html">ch12 view refactoring 2</a></li>
          <li><a href="13-form-view.md.html">ch13 form view</a></li>
          <li><a href="14-django-crispy-form.md.html">ch14 django crispy form</a></li>
          <li><a href="15-django-contrib-auth.md.html">ch15 django contrib auth</a></li>
          <li><a href="16-django-contrib-auth-2.md.html">ch16 django contrib auth 2</a></li>
          <li><a href="17-template-tags-and-ajax.md.html">ch17 template tags and ajax</a></li>
          <li><a href="18-events.md.html">ch18 events</a></li>
          <li><a href="19-class-based-view.md.html">ch19 class based view</a></li>
          <li><a href="20-class-based-view-attributes.md.html">ch20 class based view attributes</a></li>
          <li><a href="21-class-based-view-overrides.md.html">ch21 class based view overrides</a></li>
          <li><a href="22-formsets.md.html">ch22 formsets</a></li>
          <li><a href="23-finishing-touches.md.html">ch23 finishing touches</a></li>
          <li><a href="24-deploy-to-heroku.md.html">ch24 deploy to heroku</a></li>
          <li><a href="25-deploy-to-ubuntu-server.md.html">ch25 deploy to ubuntu server</a></li>
          <li><a href="26-rest-api.md.html">ch26 rest api</a></li>
          <li><a href="27-internationalisation.md.html">ch27 internationalisation</a></li>
          <li><a href="28-logging-data-migration-and-media-files.md.html">ch28 logging data migration and media files</a></li>
          <li><a href="29-template-tags-explained.md.html">ch29 template tags explained</a></li>
          <li><a href="30-moving-on.md.html">ch30 moving on</a></li>
        </ul>
      </div>
        <div id='content'>
    <p>由於使用者認證在太多網站都會用到，Django 在出廠時就會附上預設的 <code>django.contrib.auth</code> 模組。雖然是預設，但這個模組非常好用，其實沒什麼可以挑剔的地方。當你前面用到 <code>createsuperuser</code> 與 admin 介面時，其實就是用這個模組來登入。之前檢查資料庫結構時也有看到相關的 tables（名稱以 auth 開頭的就是）。</p>
<p>Django 的權限管理系統包含以下資料：</p>
<ol>
<li>一個 table 保存所有使用者資料。</li>
<li>權限系統。每個使用者都可以擁有建立、修改、刪除某個 model 的權限。</li>
<li>每個使用者都有一個 <code>is_staff</code> 與 <code>is_superuser</code> 欄位。只有 staff 可以進入後台，而 superuser 會擁有所有權限。</li>
<li>可以把使用者加入某個群組。改變群組權限可以直接改變內部使用者權限。</li>
</ol>
<p>首先我們必須建立一個登入頁面。你可以用前面的方法建立 form、view、template，但 Django 其實有內建 form 與 view 可以用；你只要設定 URL patterns 與 templates 就行。Django 提供了以下的 views：</p>
<p>view name                   | 用途<br />
----------------------------|-------<br />
<code>login</code>                     | 登入。<br />
<code>logout</code>                    | 登出。<br />
<code>password_change</code>           | 更換密碼。<br />
<code>password_change_done</code>      | 更換密碼完成後會導向這裡。<br />
<code>password_reset</code>            | 重設密碼（會寄 email 給使用者）。<br />
<code>password_reset_done</code>       | 重設密碼完成後會導向這裡。<br />
<code>password_reset_confirm</code>    | 使用者收到重設密碼 email 時，裡面會包含這個網址。<br />
<code>password_reset_complete</code>   | 使用者按下 email 中的重設連結，重設完成後，會被導向這裡。</p>
<p>由於篇幅緣故，註冊和修改密碼的頁面就直接跳過；有興趣請參照<a href="https://docs.djangoproject.com/en/1.7/topics/auth/default/#module-django.contrib.auth.views">官方文件</a>。</p>
<p>把 URL patterns 導向內建 views：</p>
<pre><code class="python language-python"># lunch/urls.py

urlpatterns = [
    # ...
    url(r'^accounts/', include('django.contrib.auth.urls')),
    # ...
]
</code></pre>
<p>接著在 <code>base/templates/base.html</code> 加上登入按鈕：</p>
<pre><code class="html language-html">&lt;!-- ... --&gt;
&lt;nav class="navbar navbar-default navbar-static-top" role="navigation"&gt;
  &lt;div class="container"&gt;
    &lt;div class="navbar-header"&gt;
      &lt;a class="navbar-brand" href="{% url 'home' %}"&gt;午餐系統&lt;/a&gt;
    &lt;/div&gt;
    &lt;div&gt;
      &lt;ul class="nav navbar-nav"&gt;
        &lt;li&gt;&lt;a href="{% url 'store_list' %}"&gt;店家列表&lt;/a&gt;&lt;/li&gt;
      &lt;/ul&gt;
      &lt;form class="navbar-right navbar-form" method="post" action="{% url 'logout' %}"&gt;
        &lt;a class="btn btn-default" href="{% url 'login' %}"&gt;登入&lt;/a&gt;
      &lt;/form&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/nav&gt;
&lt;!-- ... --&gt;
</code></pre>
<p>我們之後會談到為什麼這邊要用 form。目前就先這樣。</p>
<p>如果你現在按下登入按鈕，應該會看到一個 <code>TemplateDoesNotExist</code> 錯誤頁面。這是因為 Django 只提供了 views（與 URL patterns），但沒有提供 templates，我們要自己做。前面提過，這種不知道要放哪裡的東西我都丟到 <code>pages</code> 裡。所以新增 <code>pages/templates/registration/login.html</code>：</p>
<pre><code class="html language-html">{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block body %}
{{ block.super }}
&lt;div class="container"&gt;
  &lt;div class="row"&gt;
    &lt;div class="col-lg-4 col-md-6 col-lg-offset-4 col-md-offset-3"&gt;
      &lt;form method="post"&gt;
      {% csrf_token %}
      {{ form|crispy }}
      &lt;button type="submit" class="btn btn-primary"&gt;登入&lt;/button&gt;
      &lt;/form&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/div&gt;
{% endblock body %}
</code></pre>
<p>這樣你應該可以看到登入頁面了。輸入你的帳號密碼，然後送出看看。呃，出現了一個 Page Not Found 錯誤。這是因為 Django 預設會在登入後把使用者導向至 profile page，而我們並沒有那種東西。我們其實不需要那種東西，只要在登入後把使用者導到首頁就好。所以我們要在 <code>lunch/settings/base.py</code> 加入下面的設定：</p>
<pre><code class="python language-python">from django.core.urlresolvers import reverse_lazy

LOGIN_REDIRECT_URL = reverse_lazy('home')
</code></pre>
<p>設定本身沒什麼，不過什麼是 <code>reverse_lazy</code>？我們前面談過 <code>reverse</code> 這個函式可以把 URL pattern name 轉回 URL。但我們不能直接在這裡用 <code>reverse</code>，因為當設定檔還沒被讀進 Django 時，我們還無法使用 Django 內部的功能，包含 <code>reverse</code>。幸好，Django 的很多函式都有一個 lazy 版本——這些 lazy 函式不會立刻執行，而是會在需要結果時（以這個例子就是在 login view 真的需要重導向時）才會實際給出結果。這就避免了需要在設定載入前使用 Django 內部功能的狀況。</p>
<p>如果你現在登入，應該就會被導入到首頁。不過好像看不出來什麼區別。我們要修改 template 來反應登入狀態：</p>
<pre><code class="html language-html">{# base/templates/base.html #}

&lt;form class="navbar-right navbar-form" method="post" action="{% url 'logout' %}"&gt;
  {% if user.is_authenticated %}
  {% csrf_token %}
  &lt;input type="hidden" name="next" value="{% url 'home' %}"&gt;
  &lt;button class="btn btn-default" type="submit"&gt;登出&lt;/button&gt;
  {% else %}
  &lt;a class="btn btn-default" href="{% url 'login' %}"&gt;登入&lt;/a&gt;
  {% endif %}
&lt;/form&gt;
</code></pre>
<p>除了我們在 view 裡傳入的 context data 外，Django 預設也會設定一些全域的 template 變數。這裡用到的 <code>user</code> 就是其中之一。如果當下的 request 已經登入，則這個變數會是一個 user object（來自 <code>auth</code> 模組裡的 <code>User</code> model）；如果沒登入，則 Django 會使用一個叫做 <code>AnonymousUser</code> 的 mock object，來讓 <code>is_authenticated</code> 回傳 <code>False</code>。所以當使用者登入時，就會顯示登出按鈕，而非登入。根據 <a href="http://stackoverflow.com/questions/3521290">best practice</a>，我們在登出時應該使用 POST 而非 GET。所以你知道為什麼我們要用 form 了吧！</p>
<p>登出時，Django 預設會使用 <code>registration/logged_out.html</code> 這個 template 來顯示「你已經登出」頁面。不過我們這裡不需要這麼做，只要在登出時把使用者導回首頁即可。所以我們多加了一個隱藏欄位 <code>next</code>；如果你有加這一欄，Django 會使用裡面的內容來重導向，而不是顯示預設頁面。（登入頁面其實也有這個 <code>next</code> 參數可以用；如果你想要做動態導向，例如在登入後導回「使用者原本所在頁面」，而不是固定的頁面，就可以用這個參數。）</p>
<p>這樣就把登入登出頁面完成了！明天我們會正式使用這個權限機制，並且實作 delete view。</p>

        </div>
        
            </body>
      <script src="common.js"></script>
    </html>