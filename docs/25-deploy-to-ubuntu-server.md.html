
    <html>
      <head>
        <title>Chapter25</title>
       <meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" type="text/css" href="style.css">
      </head>
      <body>
<div class="nav">
        <ul>
          <li><a href="01-before-we-start.md.html">ch01 before we start</a></li>
          <li><a href="02-how-does-django-work.md.html">ch02 how does django work</a></li>
          <li><a href="03-a-new-project.md.html">ch03 a new project</a></li>
          <li><a href="04-run-your-project.md.html">ch04 run your project</a></li>
          <li><a href="05-django-apps.md.html">ch05 django apps</a></li>
          <li><a href="06-first-view.md.html">ch06 first view</a></li>
          <li><a href="07-django-models.md.html">ch07 django models</a></li>
          <li><a href="08-django-admin.md.html">ch08 django admin</a></li>
          <li><a href="09-model-view.md.html">ch09 model view</a></li>
          <li><a href="10-testing.md.html">ch10 testing</a></li>
          <li><a href="11-view-refactoring.md.html">ch11 view refactoring</a></li>
          <li><a href="12-view-refactoring-2.md.html">ch12 view refactoring 2</a></li>
          <li><a href="13-form-view.md.html">ch13 form view</a></li>
          <li><a href="14-django-crispy-form.md.html">ch14 django crispy form</a></li>
          <li><a href="15-django-contrib-auth.md.html">ch15 django contrib auth</a></li>
          <li><a href="16-django-contrib-auth-2.md.html">ch16 django contrib auth 2</a></li>
          <li><a href="17-template-tags-and-ajax.md.html">ch17 template tags and ajax</a></li>
          <li><a href="18-events.md.html">ch18 events</a></li>
          <li><a href="19-class-based-view.md.html">ch19 class based view</a></li>
          <li><a href="20-class-based-view-attributes.md.html">ch20 class based view attributes</a></li>
          <li><a href="21-class-based-view-overrides.md.html">ch21 class based view overrides</a></li>
          <li><a href="22-formsets.md.html">ch22 formsets</a></li>
          <li><a href="23-finishing-touches.md.html">ch23 finishing touches</a></li>
          <li><a href="24-deploy-to-heroku.md.html">ch24 deploy to heroku</a></li>
          <li><a href="25-deploy-to-ubuntu-server.md.html">ch25 deploy to ubuntu server</a></li>
          <li><a href="26-rest-api.md.html">ch26 rest api</a></li>
          <li><a href="27-internationalisation.md.html">ch27 internationalisation</a></li>
          <li><a href="28-logging-data-migration-and-media-files.md.html">ch28 logging data migration and media files</a></li>
          <li><a href="29-template-tags-explained.md.html">ch29 template tags explained</a></li>
          <li><a href="30-moving-on.md.html">ch30 moving on</a></li>
        </ul>
      </div>
        <div id='content'>
    <p>先說好，雖然 deploy 到 Heroku 和一般的 Linux server 是兩件事，但為了方便起見，有些前面講過的東西就不重複，還是建議要看前一章。我們這裡會用 Ubuntu Server 14.04 來示範，如果你習慣使用其他發行版就麻煩自己舉一反三一下。其他版本中最麻煩的可能是要自己想辦法安裝 Python 3.4（預設可能都只有 2.7），這關過了後面應該都還算差不多。</p>
<p>由於這裡可以玩的花樣很多，本章會用 nginx + Gunicorn + Supervisor + PostgreSQL 示範。上面的所有元件都可以替換，例如</p>
<ul>
<li>nginx 可以換成 Apache。</li>
<li>Gunicorn 可以換成 Waitress。</li>
<li>uWSGI 可以取代 Gunicorn 與 Supervisor。</li>
<li>如果你用 Apache，可以用 mod_wsgi 取代 Gunicorn 與 Supervisor。</li>
<li>PostgreSQL 可以換成 MySQL 或 MariaDB 甚至 Oracle Database。</li>
</ul>
<p>不過實在是沒辦法全部講完，所以只好先麻煩舉一反三了。或許之後有機會吧。</p>
<p>首先我們建立一個設定檔：</p>
<pre><code class="python language-python"># lunch/settings/deploy_ubuntu.py

from .base import *

DEBUG = False

SECRET_KEY = get_env_var('DJANGO_LUNCH_SECRET_KEY')

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql_psycopg2',
        'NAME': 'lunch',
        'USER': get_env_var('DJANGO_LUNCH_DATABASE_DEFAULT_USER'),
        'PASSWORD': get_env_var('DJANGO_LUNCH_DATABASE_DEFAULT_PASSWORD'),
        'HOST': 'localhost',
        'PORT': '',
    },
}

ALLOWED_HOSTS = ['*']

STATIC_ROOT = os.path.join(os.path.dirname(BASE_DIR), 'static')

MEDIA_ROOT = os.path.join(os.path.dirname(BASE_DIR), 'media')
</code></pre>
<p>這裡列出了 PostgreSQL 的所有設定。其中 <code>NAME</code> 是資料庫名稱，你可以自己換，<code>USER</code> 與 <code>PASSWORD</code> 顯然必須有讀寫該資料庫的權限，請自行設定。[註 1] <code>PORT</code> 留白代表使用預設 port，如果你有其他需求也可以自行修改。注意有些值我們放在環境變數中，而不直接寫在專案裡，以增加安全性。</p>
<p><code>MEDIA_ROOT</code> 的作用與 <code>STATIC_ROOT</code> 類似，只是它是用來告訴 Django 當使用者上傳檔案時，應該把檔案放在哪裡。這裡我們單純就只是把它放在外面一層的 <code>media</code> 目錄裡，但你可以設定 NFS 或者各式各樣的服務來用，只要 Django 找得到就行了。</p>
<p>接著我們要安裝一些系統元件：</p>
<pre><code class="bash language-bash">sudo apt-get update -y
sudo apt-get upgrade -y
sudo apt-get install python3 python3-pip python3-dev postgresql postgresql-contrib libpq-dev nginx supervisor -y
</code></pre>
<p>其中前兩個是必須，接下來三個是 PostgreSQL 相關，最後兩個則是字面上的意義。可以依照你的需求增減要安裝的東西。我們會用 PIP 安裝 Gunicorn，所以這裡沒有包含。[註 1]</p>
<p>接著用下面的指令修正 Ubuntu 的 Python 沒有包含 <code>ensurepip</code> 模組的問題：</p>
<pre><code class="bash language-bash">wget -qO - http://d.pr/f/mbQy+ | sudo python3
</code></pre>
<p>然後就可以開始部署專案。首先進入你想放專案的地方（以下稱 <code>/project</code>），建立 venv：</p>
<pre><code class="bash language-bash">python3 -m venv venv/lunch
</code></pre>
<p>然後把你的專案弄上去。隨便你要用什麼方法都行，當然 Git 或許是最方便的。假設你弄上去後，現在 <code>/project</code> 的結構應該會和本機端一樣。</p>
<p>把專案有用到的套件裝上去：</p>
<pre><code class="bash language-bash">. venv/lunch/bin/activate
pip install -r lunch/requirements.txt
</code></pre>
<p>雖然這會安裝一些我們用不到的東西（<code>dj-database-url</code> 之類的），不過 <code>django-toolbelt</code> 裡面也包含了 PostgreSQL 的 Python binding（<code>psycopg2</code>）與 Gunicorn，其他的反正沒佔多少空間，沒關係。</p>
<p>先把一些環境變數設起來：</p>
<pre><code class="bash language-bash">export DJANGO_LUNCH_SECRET_KEY=&lt;your_secret_key&gt;
export DJANGO_LUNCH_DATABASE_DEFAULT_USER=&lt;your_db_user&gt;
export DJANGO_LUNCH_DATABASE_DEFAULT_PASSWORD=&lt;your_db_pass&gt;
export DJANGO_SETINGS_MODULE=lunch.settings.deploy_ubuntu
</code></pre>
<p>因為這些以後你做 admin 工作時也會用到，所以建議放到 <code>venv/lunch/bin/activate</code> script 的最後面，以後進 venv 時就可以自動載入。</p>
<p>還是得記得 migrate 資料庫：</p>
<pre><code class="bash language-bash">python manage.py migrate
</code></pre>
<p>接著我們要把 static 收集起來，才能讓 static file server 找到它們。在 debug 模式中，Django 會自動處理散落在各 app 中的 static files，但在 production mode（<code>DEBUG = FALSE</code>）時，我們必須要把這些檔案收集到 <code>STATIC_ROOT</code> 中，Django 才找得到它們。</p>
<pre><code class="bash language-bash">python manage.py collectstatic
</code></pre>
<p>確認一下收集的目標是否正確（應該會是 <code>/project/static</code>），如果沒問題就按 y 開始收集吧！應該會有一堆，因為 Django 內建就有許多靜態檔（主要是 admin 會用到）。</p>
<p>設定完成！先把 dev server 跑起來，看到目前為止的設定對不對。</p>
<pre><code class="bash language-bash">python manage.py runserver 0.0.0.0:8000
</code></pre>
<p>如果都正確，你應該可以用 <a href="http://server-ip:8000/">http://server-ip:8000/</a> 看到首頁。</p>
<p>接著是 Gunicorn。在 <code>/project</code> 建立 <code>gunicorn.conf.py</code>：</p>
<pre><code class="python language-python">import os

bind = '127.0.0.1:8080'
worders = (os.sysconf('SC_NPROCESSORS_ONLN') * 2) + 1
loglevel = 'error'
command = '/project/venv/lunch/bin/gunicorn'
pythonpath = '/project/lunch'
</code></pre>
<p>這會讓 Gunicorn 使用你的 CPU 數乘二加一個 processes，然後把網頁 serve 在 <code>127.0.0.1:8080</code>，並把錯誤記錄下來。具體需要幾個 processes 效能比較好要視機器而定，所以你可能必須自己試試看其他組合，不過這個設定在多數情況都還 OK。</p>
<p>接著是 nginx。在 <code>/etc/nginx/sites-available</code> 裡建立一個設定檔：</p>
<pre><code class="nginx language-nginx">upstream lunch {
    server 127.0.0.1:8080;
}

server {
    listen 80 default_server;
    listen 443 default ssl;
    server_name &lt;your_server_name&gt;;
    client_max_body_size 10M;
    keepalive_timeout    15;

    location /static/ {
        alias           /project/static/;
    }

    location /media/ {
        alias           /project/media/;
    }

    location / {
        proxy_redirect      off;
        proxy_set_header    Host                    $host;
        proxy_set_header    X-Real-IP               $remote_addr;
        proxy_set_header    X-Forwarded-For         $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Protocol    $scheme;
        proxy_pass          http://lunch;
    }
}
</code></pre>
<p>這個設定開啟一個聽取 80（HTTP）與 443（HTTPS，我們這裡沒用到不過先開著）ports 的 server，把 <code>/media/</code> 與 <code>/static/</code> 導向我們放靜態檔與媒體檔的地方（記得把 <code>/project</code> 換成正確路徑），剩下的路徑則導向 reverse proxy <code>127.0.0.1:8080</code>，也就是上面 Gunicorn 的位置。</p>
<p>把這個設定檔連結到 <code>/etc/nginx/sites-available</code>，把 default site 的連結砍掉，然後重開 nginx：</p>
<pre><code class="bash language-bash">sudo ln -s /etc/nginx/sites-available/lunch /etc/nginx/sites-enabled
sudo rm /etc/nginx/sites-enabled/default
sudo service nginx restart
</code></pre>
<p>如果一切正確，你現在應該可以在 <code>/project</code> 把 Gunicorn 跑起來：</p>
<pre><code class="bash language-bash">gunicorn -c gunicorn.conf.py lunch.wsgi
</code></pre>
<p>然後用 server IP 看到網站了！</p>
<p>但是這樣我們要手動把 Gunicorn 跑起來才看得到網站，如果用 Ctrl-C 關掉，網站就掛了。最後一個步驟：設定 Supervisor。</p>
<p>Supervisor 是一個可以讓使用者監控機器內 processes 的工具。使用者可以把某個想執行的東西註冊進去，要求 supervisor 在特定的時候執行（例如：當你啟動時，請幫我把它也啟動），並使用 Supervisor 提供的介面查看 processes 的運行狀況，或者手動啟動、停止、重啟某個些 processes。</p>
<p>建立 <code>/etc/supervisor/conf.d/lunch.conf</code>：</p>
<pre><code class="ini language-ini">[group:lunch]
programs=site

[program:site]
directory=/project
command=/project/venv/bin/gunicorn -c /project/gunicorn.conf.py -p gunicorn.pod lunch.wsgi
autostart=true
autorestart=true
stdout_logfile=/project/supervisor.log
environment=DJANGO_LUNCH_SECRET_KEY=&lt;your_secret_key&gt;,DJANGO_LUNCH_DATABASE_DEFAULT_USER=&lt;your_db_user&gt;,DJANGO_LUNCH_DATABASE_DEFAULT_PASSWORD=&lt;your_db_pass&gt;,DJANGO_SETINGS_MODULE=lunch.settings.deploy_ubuntu
</code></pre>
<p>這個設定檔定義了一個群組，裡面有一個程式 <code>site</code>。這個程式會自動在 Supervisor 啟動時自動開始執行，切換到 <code>/poject</code> 目錄執行適當的 Gunicorn 指令。<code>environment</code> 設定指名了需要的環境變數。</p>
<p>現在我們讓 Supervisor 讀進這個設定：</p>
<pre><code class="bash language-bash">sudo supervisorctl reread
</code></pre>
<p>這應該會顯示有一個新設定 <code>lunch</code>。重新啟動 Supervisor：</p>
<pre><code class="bash language-bash">sudo supervisorctl reload
</code></pre>
<p>看看它有沒有跟著起來：</p>
<pre><code class="bash language-bash">sudo supervisorctl status
</code></pre>
<p>如果你有看到 <code>lunch:site</code> 處於 <code>RUNNING</code>，恭喜你！現在你應該可以正常使用網站了。部署成功！</p>
<hr />
<p>註 1：如果你不知道怎麼做，可以參考<a href="http://www.cyberciti.biz/faq/howto-add-postgresql-user-account/">這篇</a>。</p>

        </div>
        
            </body>
      <script src="common.js"></script>
    </html>